"""
–ú–æ–¥—É–ª—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –ó–∞–¥–∞–Ω–∏—è 2.
"""

from django.db.models import Count, Avg, Q
from .models import Author, Book, Publisher, Store, Review


def query_1_books_by_country(country="–†–æ—Å—Å–∏—è"):
    """
    –ó–∞–¥–∞–Ω–∏–µ 2.1: –ù–∞–π—Ç–∏ –≤—Å–µ –∫–Ω–∏–≥–∏, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã.
    
    –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤—è–∑—å ForeignKey –º–µ–∂–¥—É Book –∏ Publisher.
    –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ (__) –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø–æ–ª—è–º —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.
    """
    print(f"\n=== –ó–ê–ü–†–û–° 1: –ö–Ω–∏–≥–∏ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤ –∏–∑ —Å—Ç—Ä–∞–Ω—ã '{country}' ===")
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–Ω–∏–≥–∏ –ø–æ —Å—Ç—Ä–∞–Ω–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
    books = Book.objects.filter(publisher__country=country)
    
    print(f"–ù–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥: {books.count()}")
    for book in books:
        print(f"- '{book.title}' (–∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ: {book.publisher.name}, {book.publisher.country})")
    
    return books


def query_2_books_by_city(city="–ú–æ—Å–∫–≤–∞"):
    """
    –ó–∞–¥–∞–Ω–∏–µ 2.2: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–Ω–∏–≥, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–¥–∞—é—Ç—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ.
    
    –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤—è–∑—å ManyToMany –º–µ–∂–¥—É Book –∏ Store.
    """
    print(f"\n=== –ó–ê–ü–†–û–° 2: –ö–Ω–∏–≥–∏, –ø—Ä–æ–¥–∞—é—â–∏–µ—Å—è –≤ –≥–æ—Ä–æ–¥–µ '{city}' ===")
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–Ω–∏–≥–∏ –ø–æ –≥–æ—Ä–æ–¥—É –º–∞–≥–∞–∑–∏–Ω–æ–≤ (ManyToMany —Å–≤—è–∑—å)
    books = Book.objects.filter(stores__city=city).distinct()
    
    print(f"–ù–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–Ω–∏–≥: {books.count()}")
    for book in books:
        # –ü–æ–ª—É—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏
        stores_in_city = book.stores.filter(city=city)
        store_names = [store.name for store in stores_in_city]
        print(f"- '{book.title}' (–º–∞–≥–∞–∑–∏–Ω—ã: {', '.join(store_names)})")
    
    return books


def query_3_books_by_average_rating(min_rating=4.5):
    """
    –ó–∞–¥–∞–Ω–∏–µ 2.3: –ù–∞–π—Ç–∏ –≤—Å–µ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç —Å—Ä–µ–¥–Ω—é—é –æ—Ü–µ–Ω–∫—É –≤—ã—à–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
    
    –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏—é (Avg) –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏.
    """
    print(f"\n=== –ó–ê–ü–†–û–° 3: –ö–Ω–∏–≥–∏ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π –≤—ã—à–µ {min_rating} ===")
    
    # –ê–Ω–Ω–æ—Ç–∏—Ä—É–µ–º –∫–Ω–∏–≥–∏ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º
    books = Book.objects.annotate(
        avg_rating=Avg('reviews__rating')
    ).filter(
        avg_rating__gt=min_rating
    ).order_by('-avg_rating')
    
    print(f"–ù–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥: {books.count()}")
    for book in books:
        # avg_rating —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç –æ–±—ä–µ–∫—Ç–∞
        avg_rating = book.avg_rating or 0
        reviews_count = book.reviews.count()
        print(f"- '{book.title}' (—Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: {avg_rating:.2f}, –æ—Ç–∑—ã–≤–æ–≤: {reviews_count})")
    
    return books


def query_4_books_count_by_store():
    """
    –ó–∞–¥–∞–Ω–∏–µ 2.4: –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥, –ø—Ä–æ–¥–∞—é—â–∏—Ö—Å—è –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ.
    
    –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏—é Count –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
    """
    print(f"\n=== –ó–ê–ü–†–û–° 4: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ ===")
    
    # –ê–Ω–Ω–æ—Ç–∏—Ä—É–µ–º –º–∞–≥–∞–∑–∏–Ω—ã –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–Ω–∏–≥
    stores = Store.objects.annotate(
        books_count=Count('books')
    ).order_by('-books_count')
    
    print(f"–í—Å–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: {stores.count()}")
    for store in stores:
        print(f"- {store.name} (–≥. {store.city}): {store.books_count} –∫–Ω–∏–≥")
    
    return stores


def query_5_stores_by_publication_date(year=2010):
    """
    –ó–∞–¥–∞–Ω–∏–µ 2.5: –ù–∞–π—Ç–∏ –º–∞–≥–∞–∑–∏–Ω—ã, –≥–¥–µ –ø—Ä–æ–¥–∞—é—Ç—Å—è –∫–Ω–∏–≥–∏, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –¥–∞—Ç—ã.
    –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–Ω–∏–≥.
    
    –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º –ø–æ–ª—è–º –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—é.
    """
    print(f"\n=== –ó–ê–ü–†–û–° 5: –ú–∞–≥–∞–∑–∏–Ω—ã —Å –∫–Ω–∏–≥–∞–º–∏, –∏–∑–¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ {year} –≥–æ–¥–∞ ===")
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–Ω–∏–≥ –∏ —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    stores = Store.objects.filter(
        books__published_date__year__gt=year
    ).annotate(
        recent_books_count=Count('books', filter=Q(books__published_date__year__gt=year))
    ).distinct().order_by('-recent_books_count')
    
    print(f"–ù–∞–π–¥–µ–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: {stores.count()}")
    for store in stores:
        # –ü–æ–ª—É—á–∞–µ–º –∫–Ω–∏–≥–∏, –∏–∑–¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞
        recent_books = store.books.filter(published_date__year__gt=year)
        print(f"- {store.name} (–≥. {store.city}): {store.recent_books_count} –∫–Ω–∏–≥ –ø–æ—Å–ª–µ {year} –≥–æ–¥–∞")
        for book in recent_books:
            print(f"  * '{book.title}' ({book.published_date.year} –≥.)")
    
    return stores


def run_all_queries():
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –ó–∞–¥–∞–Ω–∏—è 2.
    """
    print("üîç –í–´–ü–û–õ–ù–ï–ù–ò–ï –í–°–ï–• –ó–ê–ü–†–û–°–û–í –ò–ó –ó–ê–î–ê–ù–ò–Ø 2")
    print("=" * 60)
    
    # –ó–∞–ø—Ä–æ—Å 1: –ö–Ω–∏–≥–∏ –ø–æ —Å—Ç—Ä–∞–Ω–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
    query_1_books_by_country("–†–æ—Å—Å–∏—è")
    
    # –ó–∞–ø—Ä–æ—Å 2: –ö–Ω–∏–≥–∏ –ø–æ –≥–æ—Ä–æ–¥—É –ø—Ä–æ–¥–∞–∂–∏
    query_2_books_by_city("–ú–æ—Å–∫–≤–∞")
    
    # –ó–∞–ø—Ä–æ—Å 3: –ö–Ω–∏–≥–∏ —Å –≤—ã—Å–æ–∫–æ–π —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π
    query_3_books_by_average_rating(4.5)
    
    # –ó–∞–ø—Ä–æ—Å 4: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö
    query_4_books_count_by_store()
    
    # –ó–∞–ø—Ä–æ—Å 5: –ú–∞–≥–∞–∑–∏–Ω—ã —Å –Ω–µ–¥–∞–≤–Ω–∏–º–∏ –∫–Ω–∏–≥–∞–º–∏
    query_5_stores_by_publication_date(2010)
    
    print("\n‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!")


# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
def demo_basic_queries():
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö.
    """
    print("\nüìä –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–û–ù–ù–´–ï –ó–ê–ü–†–û–°–´")
    print("=" * 40)
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print(f"–í—Å–µ–≥–æ –∞–≤—Ç–æ—Ä–æ–≤: {Author.objects.count()}")
    print(f"–í—Å–µ–≥–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤: {Publisher.objects.count()}")
    print(f"–í—Å–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: {Store.objects.count()}")
    print(f"–í—Å–µ–≥–æ –∫–Ω–∏–≥: {Book.objects.count()}")
    print(f"–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: {Review.objects.count()}")
    
    # –ö–Ω–∏–≥–∏ —Å –∞–≤—Ç–æ—Ä–∞–º–∏ (–ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å)
    print(f"\nüìö –í—Å–µ –∫–Ω–∏–≥–∏:")
    books = Book.objects.all()
    for book in books:
        print(f"- '{book.title}' - {book.author.name} ({book.published_date.year})")


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞
    demo_basic_queries()
    run_all_queries()
